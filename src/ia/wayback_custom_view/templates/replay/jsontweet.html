<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Wayback Machine</title>
    <style type="text/css">
			body {
				margin:0;
				padding: 20px;
				background-color: #000;
				min-height: 100vh;
				box-sizing: border-box;
			}
      .notice {
        border: 2px solid #c9ae00;
        background-color: #ffff00;
        padding: 12px;
      }

      .tweet-container {
        font-family: Helvetica, Arial, sans-serif;
        padding: 12px 16px;
        border: 1px solid #cfd9de;
        border-radius: 12px;
        max-width: 600px;
        margin-top: 20px;
				margin-left: auto;
				margin-right: auto;
				background-color: white;
      }

      .tweet-author {
        display: flex;
        flex-direction: row;
        align-items: center;
        padding-bottom: 0.75rem;
      }

      .tweet-author-profile-image img {
        width: 48px;
        height: 48px;
        border-radius: 50%;
        margin-right: 5px;
      }

      .tweet-author-info {
        display: flex;
        flex-direction: column;
      }

      .tweet-author-name {
        font-weight: bold;
      }

      .tweet-content {
        font-size: 1.25rem;
      }

			.tweet-image {
				width: 100%;
				height: auto;
				margin-top: 12px;
				border-radius: 12px;
			}

			.embedded-tweet-container {
				box-sizing: border-box;
				margin-top: 12px;
				padding: 12px;
				border: 1px solid #cfd9de;
        border-radius: 12px;
				background-color: white;
				max-width: 100%;
			}
			.date {
				font-size: 0.75rem;
				color: #657786;
				margin-top: 12px;
			}
			.date a {
				color: #657786;
				text-decoration: none;
			}
			.date a:hover {
				text-decoration: underline;
			}
    </style>
  </head>
  <body>
    {% if error %}
    <div>error = {{ error }}</div>
    {% endif %}
    {% if parsed_content %}
      {% set data = parsed_content %}
      
      {% if data.includes and data.includes.users %}
        {% set users = data.includes.users %}
      {% else %}
        {% set users = [] %}
      {% endif %}

      {% if data.data and data.data.author_id %}
        {% set thisauthorid = data.data.author_id %}
      {% else %}
        {% set thisauthorid = "" %}
      {% endif %}

      {% if data.includes and data.includes.media %}
        {% set media_array = data.includes.media %}
      {% else %}
        {% set media_array = [] %}
      {% endif %}

      {% if data.includes and data.includes.tweets %}
        {% set quoted_tweets = data.includes.tweets %}
      {% else %}
        {% set quoted_tweets = [] %}
      {% endif %}

      {% if data.data and data.data.entities and data.data.entities.urls %}
        {% set urls = data.data.entities.urls %}
      {% else %}
        {% set urls = [] %}
      {% endif %}

      {% if data.data and data.data.text and urls %}
        {% set outtext = data.data.text %}
        {% set newtext = namespace(text=outtext) %}
        {% for url in urls %}
          {% set newtext.text = newtext.text.replace(url.url,"") %}
        {% endfor %}
        {% set outtext = newtext.text %}
      {% else %}
        {% set outtext = "" %}
      {% endif %}

    <div class="notice">
      This is a page generated by the Internet Archiveâ€™s Wayback Machine from Twitter/X post data
    </div>
    <div class="tweet-container">
      {% for user in users %}
      {% if user.id == thisauthorid %}
      <div class="tweet-author">
        <div class="tweet-author-profile-image">
          <img src="{{ context.make_replay_url(user.profile_image_url, flags=['im']) }}" alt="{{ user.name }}" />
        </div>
        <div class="tweet-author-info">
          <div class="tweet-author-name">{{ user.name }}</div>
          <div class="tweet-author-username">@{{ user.username }}</div>
        </div>
      </div>
      {% endif %}
      {% endfor %}
      <div class="tweet-content">{{outtext | replace('\n', '<br />') }}
				{% for media in media_array %}
          {% if media.type == "photo" %}
            <img class="tweet-image" src="{{context.make_replay_image_url(media.url, flags=['im']) }}" />
          {% endif %}
					{% if media.type == "video" %}
						<video class="tweet-image tweet-video" controls>
							{% for variant in media.variants %}
								<source src="{{ context.make_replay_image_url(variant.url, flags=['im']) }}" type="{{ variant.content_type }}">
							{% endfor %}
						</video>
					{% endif %}
        {% endfor %}
				<!-- If there's a quoted tweet, embed it here! -->
        <!-- THIS IS FAILING REMOTELY -->
				{% for tweet in quoted_tweets %}
            {% if tweet.id != data.data.id %}
              {% with tweet=tweet %}
                {% include 'replay/jsontweetquoted.html' %}
              {% endwith %}
            {% endif %}
				{% endfor %}
				<p class="date"><a id="parentdate" href="/" ></a></p>
			</div>
      <script>
        console.log({{ data | tojson | safe }});
        console.log({{ media_array | tojson | safe }});
        console.log({{ quoted_tweets | tojson | safe }});
				var dateString = "{{ data.data.created_at }}";
				var date = new Date(dateString);
        var currentURL = window.location.href;
				document.querySelector("#parentdate").innerText = date;
        document.querySelector("#parentdate").href = currentURL;
        </script>
    </div>
    {% else %}
      <div class="notice">
        Something went wrong! No parsed content!
      </div>
    {% endif %}
  </body>
</html>
